{% extends "site_base.html" %}

{% block page-subtitle %}{{ block.super }} | {% firstof obj.label obj.pid %} | Edit{% endblock %}
{% block style %} {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}/style/edit.css" />
  {% with jqui_theme=STATIC_URL|add:'style/jquery-ui/redmond' %}
    <link rel=stylesheet type=text/css href="{{ jqui_theme }}/jquery-ui-1.8.16.custom.css" > 
  {% endwith %}
{% endblock %}
{% block scripts %} {{ block.super }}
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.dirtyform.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.fadingMessage.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.userLookup.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
     $(".netid-lookup").userLookup({
     	url: "{% url accounts:user-name 'USERNAME'%}",
        url_replace: "USERNAME",
      });
      {# track changes on the edit form and warn if user tries to leave without saving #}
      $("#edit-form").dirty_form(); {# NOTE: could use .changed css class to highlight modified fields #}
      {# warn when any links are clicked or on browser navigation #}
      var msg =  "You have made changes without saving.";
      window.onbeforeunload = function(){  
        if($('.dirtyform').are_dirty()) { return msg; }
      } 
      $("#edit-form").bind("submit", function() { window.onbeforeunload = null; return True; }); 
      $("a").dirty_stopper({message:"<p>"+msg+"</p><p>Are you sure you want to proceed?</p>"});


     {# configure autocomplete fields and corresponding urls #}
     $("input[name^='funders-']").autocomplete({
     	source: "{% url publication:suggest 'funder' %}",
      });
     $("input[name='journal-title']").autocomplete({
     	source: "{% url publication:suggest 'journal_title' %}"
      });
     $("input[name='journal-publisher']").autocomplete({
     	source: "{% url publication:suggest 'journal_publisher' %}"
      });
     $("input[name^='keywords']").autocomplete({
     	source: "{% url publication:suggest 'keyword' %}"
      });
     $("input[name$='affiliation']").autocomplete({
     	source: "{% url publication:suggest 'author_affiliation' %}"
      });
  });
</script>
{% endblock %}

{% block content %}
<h1>Edit Record</h1>
<p class="info">Created {{ obj.created }}; last modified {{ obj.modified }}</p>

{% if invalid_form %}
  <p class="error">The form could not be processed.  Please check below
  for missing or invalid entries.</p>
{% endif %}

<form id="edit-form" method="post">{% csrf_token %}
  {{ form.non_field_errors }}
  <div id="title_info" class="subform">  {# title information #}
    <p class="label">{{ form.subforms.title_info.form_label }}</p>
    {{ form.subforms.title_info.as_p }}
  </div>
  <div id="authors" class="subform"> {# authors #}
    <p class="label">{{ form.formsets.authors.form_label }}</p>
    {{ form.formsets.authors.management_form }} 
    {# TODO: add some preliminary instructions about authors here; #}
    {# specifically, instruct to edit Emory directory name to match publication name #}
    {% for authorform in form.formsets.authors %} {# needs subdiv for js updating #}
       <div> {{ authorform.as_p }} </div>
    {% endfor %}
  </div>
  <div id="funders" class="subform"> {# funding agency #}
    <p class="label">{{ form.formsets.funders.form_label }}</p>
    {{ form.formsets.funders.as_p }} {# TODO: customize delete #}
  </div>
  <hr/> {# article version - top level field, not sure where to display #}
  <p class="{{ form.version.css_classes }}">{{ form.version.errors }}
        <label for="id_{{ form.version.id }}">{{ form.version.label }}:</label>
        {{ form.version }}
  </p>
  <p class="pubdate {{ form.publication_date.css_classes }}">{{ form.publication_date.errors }}
        <label for="id_{{ form.publication_date.id }}">{{ form.publication_date.label }}:</label>
        {{ form.publication_date }}
  </p>
  <p class="{{ form.language_code.css_classes }}">{{ form.language_code.errors }}
        <label for="id_{{ form.language_code.id }}">{{ form.language_code.label }}:</label>
        {{ form.language_code }} 
        <p class="helptext">{{ form.language_code.help_text }}</p>
  </p>
  <p class="{{ form.subjects.css_classes }}">{{ form.subjects.errors }}
        <label for="id_{{ form.subjects.id }}">{{ form.subjects.label }}:</label>
        {{ form.subjects }} 
        <p class="helptext">{{ form.subjects.help_text }}</p>
  </p>
  <div id="journal_info" class="subform"> {# journal info #}
    <p class="label">{{ form.subforms.journal.form_label }}</p>
    {% for field in form.subforms.journal %}
      <p class="{{ field.css_classes }}"> {{ field.errors }}
        <label for="id_{{ field.id }}">{{ field.label }}:</label>
        {{ field }}
      </p>
    {% endfor %}
    {% with form.subforms.journal.subforms.volume as subform %} {# volume number #}
      <p>
        <label>{{ subform.form_label }}:</label>      
        {{ subform.number }}
      </p>
    {% endwith %}
    {% with form.subforms.journal.subforms.number as subform %} {# issue number #}
      <p>
        <label>{{ subform.form_label }}:</label>      
        {{ subform.number }}
      </p>
    {% endwith %}
    {% with form.subforms.journal.subforms.pages as subform %} {# pages #}
      <p class="pages">
        {{ subform.non_field_errors }}
        <label>{{ subform.form_label }}:</label>      
        {{ subform.start }} - {{ subform.end }}
      </p>
    {% endwith %}
  </div>
  <div id="final_version" class="subform">  {# final version URL/DOI #}
    <p class="label">{{ form.subforms.final_version.form_label }}</p>
    {{ form.subforms.final_version.as_p }}
  </div>

  <div id="abstract" class="subform"> {# abstract #}
    <p class="label">{{ form.subforms.abstract.form_label }}</p>
    {{ form.subforms.abstract.as_p }} 
  </div>
  <div id="author_notes" class="subform"> {# author notes #}
    <p class="label">{{ form.formsets.author_notes.form_label }}</p>
    {{ form.formsets.author_notes.as_p }} {# TODO: customize delete #}
  </div>
  <div id="keywords" class="subform"> {# keywords #}
    <p class="label">{{ form.formsets.keywords.form_label }}</p>
    {{ form.formsets.keywords.as_p }} {# TODO: customize delete #}
  </div>
  <div id="other-urls" class="subform"> {# other version URLs #}
    <p class="label">{{ form.formsets.locations.form.form_label }}</p>
    <p class="helptext">Other versions of this  article (e.g., 
    	in PubMed or another repository)</p>
    {{ form.formsets.locations.as_p }}
  </div>

  {% if perms.publication.review_article %}
    <div id="mark-reviewed">
      {% if obj.provenance.content.review_event %}
        <p class="info">{{ obj.provenance.content.review_event.detail }} on 
        {{ obj.provenance.content.review_event.date }}</p>
      {% else %}
        <label for="id_{{ form.reviewed.id }}">{{ form.reviewed.label }}:</label>
        {{ form.reviewed }} 
        <p class="helptext">{{ form.reviewed.help_text }}</p>
      {% endif %}
    </div>
  {% endif %}

  {% if perms.publication.review_article %} {# admin submit button #}
    <input type="submit" name="review-record" value="Save"/>
  {% else %} {# author submit button options #}
  {# TODO: add help text here to explain the difference... #}
    <input type="submit" name="save-record" value="Save"/>
    <input type="submit" name="publish-record" value="Publish"/>
  {% endif %}

</form>
{% endblock %}