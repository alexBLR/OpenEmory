{% extends "site_base.html" %}

{% block page-subtitle %}{{ block.super }} | {% firstof obj.label obj.pid %} | Edit{% endblock %}
{% block style %} {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}/style/edit.css" />
  {% with jqui_theme=STATIC_URL|add:'style/jquery-ui/redmond' %}
    <link rel=stylesheet type=text/css href="{{ jqui_theme }}/jquery-ui-1.8.16.custom.css" > 
  {% endwith %}
{% endblock %}
{% block scripts %} {{ block.super }}
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.dirtyform.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.fadingMessage.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.formset.min.js"></script> 
<script type="text/javascript">
  $(document).ready(function() {
     $("input[name='emory-faculty']").autocomplete({
     	source: "{% url accounts:faculty-autocomplete %}",
        select: function(event, ui) {
          $("#authors").find("a.add-row").click();  // add an empty form
          var row = $(".author-form:last");  
          // set input values based on selected item
          row.find("input[name$='id']").val(ui.item.username);
          row.find("input[name$='given_name']").val(ui.item.first_name);
          row.find("input[name$='family_name']").val(ui.item.last_name);
          row.find("input[name$='affiliation']").val(ui.item.affiliation);
          row.find("input").attr("readonly", "readonly").addClass("readonly");
          // clear out autocomplete input value
          this.value = '';
          return false;
        }
      }).data("autocomplete")._renderItem = function(ul, item) {
      	return $("<li></li>")
        	.data("item.autocomplete", item)
                .append("<a>" + item.label + "<span class='description'>" + item.description + "</span></a>")
                .appendTo(ul);
                return false;
      };

      $(".author-form").formset({
          prefix: "{{ form.formsets.authors.prefix }}",
          addText: "+ Add Author",
          formCssClass: "dynamic-authorformset",
          added: function(row) {
            // ensure newly-added rows are NOT read-only by default
            row.find("input").removeAttr("readonly").removeAttr("tabindex").removeClass("readonly");
          },
      });

      $(".funding-form").formset({
          prefix: "{{ form.formsets.funders.prefix }}",
          formCssClass: "dynamic-funderformset",
      });
      
      {# track changes on the edit form and warn if user tries to leave without saving #}
      $("#edit-form").dirty_form(); {# NOTE: could use .changed css class to highlight modified fields #}
      {# warn when any links are clicked or on browser navigation #}
      var msg =  "You have made changes without saving.";
      window.onbeforeunload = function(){  
        if($('.dirtyform').are_dirty()) { return msg; }
      } 
      $("#edit-form").bind("submit", function() { window.onbeforeunload = null; return true; }); 
      $("a").dirty_stopper({message:"<p>"+msg+"</p><p>Are you sure you want to proceed?</p>"});


     {# configure autocomplete fields and corresponding urls #}
     $("input[name^='funders-']").autocomplete({
     	source: "{% url publication:suggest 'funder' %}",
      });
     $("input[name='journal-title']").autocomplete({
     	source: "{% url publication:suggest 'journal_title' %}"
      });
     $("input[name='journal-publisher']").autocomplete({
     	source: "{% url publication:suggest 'journal_publisher' %}"
      });
     $("input[name^='keywords']").autocomplete({
     	source: "{% url publication:suggest 'keyword' %}"
      });
     $("input[name$='affiliation']").autocomplete({
     	source: "{% url publication:suggest 'author_affiliation' %}"
      });
  });
</script>
{% endblock %}

{% block content %}
<h1>Edit Record</h1>
<p class="info">Created {{ obj.created }}; last modified {{ obj.modified }}</p>

{% if invalid_form %}
  <p class="error">The form could not be processed.  Please check below
  for missing or invalid entries.</p>
{% endif %}

<form id="edit-form" method="post" enctype="multipart/form-data">{% csrf_token %}
  {{ form.non_field_errors }}
  <div id="title_info" class="subform">  {# title information #}
    <p class="label">{{ form.subforms.title_info.form_label }}</p>
    {{ form.subforms.title_info.as_p }}
  </div>
  <div id="authors" class="subform"> {# authors #}
    <p class="label">{{ form.formsets.authors.form_label }}</p>
    <p>Start typing <em>Lastname, First</em> to find Emory authors: <input name="emory-faculty"/></p>
    <hr/>

    {# TODO: add some preliminary instructions about authors here; #}
    {# specifically, instruct to edit Emory directory name to match publication name #}
    <table>
      <tr><th>First Name</th><th>Last Name</th><th>Affiliation</th></tr>
    {% for authorform in form.formsets.authors %} 
      {% if authorform.non_field_errors %}
        <tr class="errors"><td colspan="3">{{ authorform.non_field_errors }}</td></tr>
      {% endif %}
       <tr class="author-form"> 
         <td>
           {{ authorform.id.errors }}{{ authorform.id }}{# (hidden id) #} 
           {{ authorform.given_name.errors }} {{ authorform.given_name }}{{ authorform.given_name.help_text }}
         </td>
         <td>{{ authorform.family_name }}</td>
         <td>{{ authorform.affiliation }}</td>
         <td>{% if forloop.counter < form.formsets.authors.initial_form_count %}
         	{{ authorform.DELETE }} {# only delete if in original formset #}
             {% endif %}
         </td>
       </tr>
    {% endfor %}
    </table>
    {{ form.formsets.authors.management_form }} 
  </div>
  <div id="funders" class="subform"> {# funding agency #}
    <p class="label">{{ form.formsets.funders.form_label }}</p>
    {% for funder in form.formsets.funders %}
      <div class="funding-form">{{ funder.name }}
      {% if forloop.counter < form.formsets.funders.initial_form_count %}{{ funder.DELETE }}{% endif %}
      </div>
    {% endfor %}
    {{ form.formsets.funders.management_form }} 
  </div>
  <hr/> {# article version - top level field, not sure where to display #}
  <p class="{{ form.version.css_classes }}">{{ form.version.errors }}
        <label for="id_{{ form.version.id }}">{{ form.version.label }}:</label>
        {{ form.version }}
  </p>
  <p class="pubdate {{ form.publication_date.css_classes }}">{{ form.publication_date.errors }}
        <label for="id_{{ form.publication_date.id }}">{{ form.publication_date.label }}:</label>
        {{ form.publication_date }}
  </p>
  <p class="{{ form.language_code.css_classes }}">{{ form.language_code.errors }}
        <label for="id_{{ form.language_code.id }}">{{ form.language_code.label }}:</label>
        {{ form.language_code }} 
        <p class="helptext">{{ form.language_code.help_text }}</p>
  </p>
  <p class="{{ form.subjects.css_classes }}">{{ form.subjects.errors }}
        <label for="id_{{ form.subjects.id }}">{{ form.subjects.label }}:</label>
        {{ form.subjects }} 
        <p class="helptext">{{ form.subjects.help_text }}</p>
  </p>
  <div id="journal_info" class="subform"> {# journal info #}
    <p class="label">{{ form.subforms.journal.form_label }}</p>
    {% for field in form.subforms.journal %}
      <p class="{{ field.css_classes }}"> {{ field.errors }}
        <label for="id_{{ field.id }}">{{ field.label }}:</label>
        {{ field }}
      </p>
    {% endfor %}
    {% with form.subforms.journal.subforms.volume as subform %} {# volume number #}
      <p>
        <label>{{ subform.form_label }}:</label>      
        {{ subform.number }}
      </p>
    {% endwith %}
    {% with form.subforms.journal.subforms.number as subform %} {# issue number #}
      <p>
        <label>{{ subform.form_label }}:</label>      
        {{ subform.number }}
      </p>
    {% endwith %}
    {% with form.subforms.journal.subforms.pages as subform %} {# pages #}
      <p class="pages">
        {{ subform.non_field_errors }}
        <label>{{ subform.form_label }}:</label>      
        {{ subform.start }} - {{ subform.end }}
      </p>
    {% endwith %}
  </div>
  <div id="final_version" class="subform">  {# final version URL/DOI #}
    <p class="label">{{ form.subforms.final_version.form_label }}</p>
    {{ form.subforms.final_version.as_p }}
  </div>

  <div id="abstract" class="subform"> {# abstract #}
    <p class="label">{{ form.subforms.abstract.form_label }}</p>
    {{ form.subforms.abstract.as_p }} 
  </div>
  <div id="author_notes" class="subform"> {# author notes #}
    <p class="label">{{ form.formsets.author_notes.form_label }}</p>
    {{ form.formsets.author_notes.as_p }} {# TODO: customize delete #}
  </div>
  <div id="keywords" class="subform"> {# keywords #}
    <p class="label">{{ form.formsets.keywords.form_label }}</p>
    {{ form.formsets.keywords.as_p }} {# TODO: customize delete #}
  </div>
  <div id="other-urls" class="subform"> {# other version URLs #}
    <p class="label">{{ form.formsets.locations.form.form_label }}</p>
    <p class="helptext">Other versions of this  article (e.g., 
    	in PubMed or another repository)</p>
    {{ form.formsets.locations.as_p }}
  </div>

  <div id="embargo" class="{{ form.embargo_duration.css_classes }}">
    {# top level field, not sure where to display #}
    {{ form.embargo_duration.errors }}
    <label for="id_embargo_duration">{{ form.embargo_duration.label }}:</label>
    {{ form.embargo_duration }}
    <p class="helptext">{{ form.fields.embargo_duration.help_text }}</p>
  </div>

  <div id="author_agreement" class="{{ form.author_agreement.css_classes }}">
    {# top level field #}
    {{ form.author_agreement.errors }}
    <label for="id_author_agreement">{{ form.author_agreement.label }}:</label>
    {{ form.author_agreement }}
    <p class="helptext">
      {% if obj.authorAgreement.exists %}
        Replace the currently uploaded author agreement with a new one.
      {% else %}
        {{ form.author_agreement.help_text }}
      {% endif %}
    </p>
  </div>


  {% if perms.publication.review_article %}
    <div id="mark-reviewed">
      {% if obj.provenance.content.review_event %}
        <p class="info">{{ obj.provenance.content.review_event.detail }} on 
        {{ obj.provenance.content.review_event.date }}</p>
      {% else %}
        <label for="id_{{ form.reviewed.id }}">{{ form.reviewed.label }}:</label>
        {{ form.reviewed }} 
        <p class="helptext">{{ form.reviewed.help_text }}</p>
      {% endif %}
    </div>
  {% endif %}

  {% if perms.publication.review_article %} {# admin submit button #}
    <input type="submit" name="review-record" value="Save"/>
  {% else %} {# author submit button options #}
  {# TODO: add help text here to explain the difference... #}
    <input type="submit" name="save-record" value="Save"/>
    <input type="submit" name="publish-record" value="Publish"/>
  {% endif %}

</form>
{% endblock %}
