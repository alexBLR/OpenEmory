{% extends "site_base.html" %}
{% load account_extras %}
{% load publication_extras %}
{% load tags %}

{% block page-subtitle %}{{ block.super }} | 
 {% firstof article.mods.content.title article.label article.pid %}{% endblock %}

{% block content %}
{% with article.descMetadata.content as mods %}

<div id="article-links">
  <h3>Article Tools</h3>
  {% if article.pdf.exists %} {# link to download PDF, if available #}
    {% if article.is_embargoed %}
      <p>Access to PDF restricted until {{ article.embargo_end_date|date:"Y-m-d" }}</p>
    {% endif %}
    {% if not article.is_embargoed or user.is_authenticated and user.username in article.owner or perms.publication.view_embargoed %}
      <p><a rel="alternate" href="{% url publication:pdf article.pid %}">PDF</a> 
        <img src="{{ STATIC_URL }}images/pdf.jpg" alt="[PDF]"/> 
        <span class="info">({{article.pdf.size|filesizeformat }})</span>
      </p>
    {% endif %}
  {% endif %}
  {% if article.pmcid %}
    <p><a rel="alternate" href="{{ article.pmcid|pmc_url }}" title="view article on PubMed Central">view on PubMed Central</a></p>
  {% endif %}
  {% if mods.final_version.url %}
    <p><a rel="alternate" href="{{ mods.final_version.url }}">Final published version</a></p>
  {% endif %}
  {% if mods.locations %}
  <p id="other-versions">
    {% for loc in mods.locations %}<a rel="alternate" href="{{ loc.url }}">Other version</a>{% endfor %}
  </p>
  {% endif %}

  {% if request.user.is_superuser %} {# FIXME: better perms check (show to admins) #}
   <p>
    {% if article.descMetadata.exists %}
      <a href="{% url publication:ds article.pid 'descMetadata' %}">MODS</a>
    {% endif %}
    {% if article.contentMetadata.exists %}
      {# for now, only content metadata we have is NLM XML #}
      <a href="{% url publication:ds article.pid 'contentMetadata' %}">NLM</a>
    {% endif %}
    {% if article.provenance.exists %}
      <a href="{% url publication:ds article.pid 'provenanceMetadata' %}">PREMIS</a>
    {% endif %}

   </p>
  {% endif %}
  {# display an edit link when appropriate -  author+unpublished or reviewer #}
  {% if user.is_authenticated %}
   {% if user.username in article.owner and article.state = 'I' or perms.publication.review_article %}
    <p><img src="{{ STATIC_URL }}images/edit.png" alt="" title="edit"/>
       <a href="{% url publication:edit article.pid %}">edit this record</a>
    </p>
   {% endif %}
   {% if user.username in article.owner or user.is_superuser %}
    {% if article.authorAgreement.exists %}
      <p><a href="{% url publication:private_ds article.pid "authorAgreement" %}">view author agreement</a></p>
    {% endif %}
   {% endif %}
  {% endif %}

  <h3>Statistics</h3>
  {% with article.aggregate_statistics as stats %}
    <p><span class="num_views">{{ stats.num_views|default:0 }}</span> view{{ stats.num_views|pluralize }}</p>
    <p><span class="num_downloads">{{ stats.num_downloads|default:0 }}</span> download{{ stats.num_downloads|pluralize }}</p>
  {% endwith %}

</div>

<div id="article">
  {% include "publication/snippets/article_title.html" %}
  {% include "publication/snippets/article_authors.html" %}
  {% include "publication/snippets/article_journal.html" %}
  {% if mods.abstract %}
    <div id="abstract">{{ mods.abstract.text }}</div>
  {% endif %}

  {% if mods.author_notes %}
    <div id="author-notes" class="section">
      <h3>Author Notes</h3>
      {% for an in mods.author_notes %}<p>{{ an|urlize }}</p>{% endfor %}
    </div>
  {% endif %}

  {% if mods.subjects or mods.keywords %}
  <div id="subjects" class="section">
      <h3>Subject</h3>
      <p>{% for s in mods.subjects %}<a href="{% url publication:search %}?subject={{s.topic|urlencode}}">{{ s.topic }}</a>{% if not forloop.last %}; {% endif %}{% endfor %}</p>
      <p>{% for kw in mods.keywords %}<a>{{ kw.topic }}</a>{% if not forloop.last %}; {% endif %}{% endfor %}</p>
  </div>
  {% endif %}

  {% if mods.funders %}
  <div id="funders" class="section">
    <h3>Research Funded in Part By</h3>
    {% for f in mods.funders %}<p>{{ f.name }}</p>{% endfor %}
  </div>
  {% endif %}

  {% if article.contentMetadata.exists %}{# display harvested article permissions, if available #}
     {% with nlm=article.contentMetadata.content %}
       {% if nlm.copyright or nlm.license %}
       <div id="permissions" class="section">
         <h3>Copyright information</h3>
         {% if nlm.copyright %}<p>{{ nlm.copyright }}</p>{% endif %}
         {% if nlm.license %}<div class="license">
             {{ nlm.license.html|urlize }} {# urlize in case of untagged links #}
             {# if license link is not included in text OR is a creative commons, link to it #}
             {% if nlm.license.link and nlm.license.link not in nlm.license.text or nlm.license.is_creative_commons %}
             <p><a class="license-link" href="{{ nlm.license.link}}">
                 {% if nlm.license.is_creative_commons %} {# use CC image if possible #}
                   <img src="{{ STATIC_URL }}images/cc/{{ nlm.license.cc_type }}.png"
                        alt="Creative Commons License"/>
                 {% else %}{{ nlm.license.link }}{% endif %}
               </a></p>
             {% endif %} {# end license link #}
           </div>{% endif %} {# end has license #}
       </div>
       {% endif %} {# end permissions #}
     {% endwith %}
  {% endif %}

  {% if mods.title_info or mods.journal.publisher %}
  <div class="section" id="additional-info">
    <h3>Additional Information</h3>
    <p>How to Cite {% if mods.journal.publisher %} | Publisher{% endif %}
       | <a onClick="$('#additional-info > div').toggle()">show/hide all</a>
    </p>

    <div id="cite" class="section">
      <h3>How to Cite</h3>
      <p id="citation">Citation TODO</p> {# TODO #}
    </div>

    {% if mods.journal.publisher %}
    <div id="publisher" class="section">
      <h3>Publisher</h3>
      <p>{{ mods.journal.publisher }}</p>
    </div>
    {% endif %}
    {% if article.pid %}
    <div id="pid" class="section">
      <h3>Pid</h3>
      <p>{{ article.pid }}</p>
    </div>
    {% endif %}
  </div>
  {% endif %}

    {% if mods.ark_uri %}
    <div id="permalink" class="section">
      <h3>Permanent URL</h3>
      <p><a rel="bookmark" href="{{ mods.ark_uri }}">{{ mods.ark_uri }}</a></p>
    </div>
    {% endif %}

</div>
{% endwith %}
{% endblock %}
